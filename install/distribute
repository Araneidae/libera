#!/bin/sh

# Script to build the distribution

TARGET="${1:?Where to put the files?}"

cd "$(dirname "$0")/.." &&

# Pick up the version
. install/CONFIG  &&

# Need to build the .db files in case the recipient doesn't have the epics
# Python library.  
make &&
mkdir install/prebuilt &&
for f in sensors libera; do
    sed '/^# \*\*\* Please do not edit/d' db/$f.db >install/prebuilt/$f.db
done  &&
cp liberaApp/src/O.linux-arm/divide-lookup.h install/prebuilt  &&

# Make sure we now start with a fresh page
make clean uninstall &&

# Build the distribution.  
EPICS="$TARGET"/libera-epics-"$VERSION".tgz  &&
tar czf "$EPICS"  --exclude=.svn --exclude=Libera/opi -C.. Libera  &&

# Finally get rid of the prebuilt files again: we don't want them normally.
rm -rf install/prebuilt  &&

echo 'Distribution built ok in:'$'\n'"    $EPICS"
